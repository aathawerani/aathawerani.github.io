name: Generate GitHub stats
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  fetch-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq & curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch GitHub user & repo stats (aggregate)
        env:
          GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          API="https://api.github.com"
          H="Authorization: token $GITHUB_API_TOKEN"

          # basic user info
          user_json=$(curl -s -H "$H" "$API/users/$GH_USER")
          followers=$(echo "$user_json" | jq '.followers // 0')
          public_repos=$(echo "$user_json" | jq '.public_repos // 0')

          # gather all repos (handle pagination)
          all_repos='[]'
          page=1
          while :; do
            page_repos=$(curl -s -H "$H" "$API/users/$GH_USER/repos?per_page=100&page=$page")
            len=$(echo "$page_repos" | jq 'length')
            if [ "$len" -eq 0 ]; then break; fi
            all_repos=$(echo "$all_repos $page_repos" | jq -s 'add')
            page=$((page+1))
          done

          total_stars=$(echo "$all_repos" | jq '[.[] .stargazers_count] | add // 0')
          total_forks=$(echo "$all_repos" | jq '[.[] .forks_count] | add // 0')

          # total commits by summing contributor stats per repo (owner/name)
          total_commits=0
          echo "$all_repos" | jq -r '.[] | "\(.owner.login) \(.name)"' | while read -r owner repo; do
            contribs=$(curl -s -H "$H" "$API/repos/$owner/$repo/contributors?per_page=100")
            # contributions for our user in this repo
            user_contrib=$(echo "$contribs" | jq --arg u "$GH_USER" 'map(select(.login==$u)) | .[0].contributions // 0')
            # add to running total (use jq to sum because we're in a subshell)
            total_commits=$(jq -n --arg a "$total_commits" --arg b "$user_contrib" '$a|tonumber + ($b|tonumber)')
          done
          # ensure numeric
          total_commits=$(echo "$total_commits" | jq '.' )

          # PR counts using Search API
          prs_opened=$(curl -s -H "$H" "$API/search/issues?q=type:pr+author:$GH_USER" | jq '.total_count // 0')
          prs_merged=$(curl -s -H "$H" "$API/search/issues?q=type:pr+author:$GH_USER+is:merged" | jq '.total_count // 0')

          # recent push events (last up to ~300 events by paging)
          pushes=0
          for p in 1 2 3; do
            evs=$(curl -s -H "$H" "$API/users/$GH_USER/events?per_page=100&page=$p")
            if [ "$(echo "$evs" | jq 'length')" -eq 0 ]; then break; fi
            push_count=$(echo "$evs" | jq '[.[] | select(.type=="PushEvent")] | length')
            pushes=$((pushes + push_count))
          done

          # a simple custom "score" (not official rank) â€” tweak as desired
          score=$(jq -n --argjson f "$followers" --argjson s "$total_stars" --argjson c "$total_commits" --argjson r "$public_repos" --argjson m "$prs_merged" \
            '$f*2 + $s*3 + $c*1 + $r*5 + $m*10')

          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          mkdir -p _data

          jq -n \
            --argjson followers "$followers" \
            --argjson public_repos "$public_repos" \
            --argjson total_stars "$total_stars" \
            --argjson total_forks "$total_forks" \
            --argjson total_commits "$total_commits" \
            --argjson prs_opened "$prs_opened" \
            --argjson prs_merged "$prs_merged" \
            --argjson pushes_recent "$pushes" \
            --arg score "$score" \
            --arg updated_at "$ts" \
            '{followers:$followers, public_repos:$public_repos, total_stars:$total_stars, total_forks:$total_forks, total_commits:$total_commits, prs_opened:$prs_opened, prs_merged:$prs_merged, pushes_recent:$pushes, score:($score|tonumber), updated_at:$updated_at}' \
            > _data/github_stats.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add _data/github_stats.json
          git commit -m "chore: update github stats (${ts})" || echo "no changes to commit"
          git push